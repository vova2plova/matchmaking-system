### Product Requirements Document (PRD): Matchmaking Service

### 1. Введение

#### 1.1. Обзор
Matchmaking Service — это самодостаточный, самодостаточный Backend-as-a-Service (BaaS) с открытым исходным кодом для подбора соперников в многопользовательских играх. Сервис предоставляет гибкий API для интеграции систем рейтингового подбора в игровые проекты, позволяя разработчикам сосредоточиться на геймплее, а не на инфраструктуре матчмейкинга.

#### 1.2. Проблема
Разработка надежной, справедливой и масштабируемой системы подбора соперников является сложной и ресурсоемкой задачей для многих игровых студий, особенно для небольших команд и инди-разработчиков. Существующие коммерческие решения часто являются "черным ящиком", дорогими и не предоставляют достаточной гибкости для кастомизации.

#### 1.3. Цели
Упростить интеграцию матчмейкинга: Предоставить простой REST/gRPC API для быстрого внедрения системы подбора соперников.

Обеспечить гибкость: Сделать рейтинговые системы и логику подбора легко заменяемыми модулями.

Снизить затраты: Быть открытой и бесплатной альтернативой коммерческим сервисам.

Обеспечить самодостаточность: Позволить развернуть сервис на собственной инфраструктуре.

### 2. Описание продукта
#### 2.1. Функциональные возможности
##### 2.1.1. Основной поток матчмейкинга
Поиск матча: Игрок (через игровой клиент) отправляет запрос на поиск матча, указывая режим игры (например, 1v1, 2v2).

Постановка в очередь: Сервис помещает игрока в очередь для выбранного режима, используя его текущий рейтинг, полученный из внешнего сервиса.

Поиск соперников: Сервис периодически сканирует очереди, подбирая игроков/команды с близким рейтингом и соблюдая конфигурируемые параметры (максимальное время ожидания, разница в рейтинге).

Формирование матча: Когда подходящая группа игроков найдена, сервис формирует матч.

Уведомление: Сервис уведомляет игровые клиенты/серверы о найденном матче, возвращая идентификатор матча и данные об игроках.

Завершение матча: После окончания матча игровой сервер отправляет результаты в Matchmaking Service.

Обновление рейтинга: Сервис передает результаты во внешний сервис рейтингов для их пересчета. Важно: сам Matchmaking Service не хранит итоговые рейтинги.

##### 2.1.2. Управление очередями
Поддержка нескольких независимых очередей для разных режимов игры (1v1, 2v2, 3v3, 6v6).

Конфигурируемый размер команды для каждого режима.

Возможность для игрока отменить поиск матча.

### 2.2. Ключевые компоненты системы
API Gateway (REST/gRPC): Точка входа для всех внешних запросов.

Matchmaking Engine: Ядро системы, отвечающее за логику поиска и формирования матчей.

Queue Manager: Управляет очередями игроков для каждого игрового режима.

Rating Calculator Abstraction: Абстракция для работы с различными рейтинговыми системами (Elo, Glicko-2 и т.д.). Вычисляет ожидаемый результат и изменение рейтинга, но не хранит его финальное значение.

External Service Adapter: Адаптер для взаимодействия с внешним сервисом пользователей и рейтингов.

### 2.3. Технические детали
Язык программирования: Go (Golang)

Архитектура: Микросервисная/модульная.

Лицензия: MIT или Apache 2.0 (для максимальной открытости).

Хранение данных: Используется только для внутреннего состояния (очереди, активные поиски). Рейтинги и профили пользователей хранятся во внешней системе.

### 3. Product Requirements
#### 3.1. Функциональные требования (Functional Requirements, FR)
ID	Requirement
FR1	Система должна предоставлять RESTful API для всех операций матчмейкинга.
FR2	Система должна позволять игроку начать поиск матча, указав желаемый режим игры.
FR3	Система должна позволять игроку отменить активный поиск матча.
FR4	Система должна получать текущий рейтинг игрока из внешнего сервиса перед помещением в очередь.
FR5	Логика подбора соперников должна основываться на разнице рейтинга между игроками/командами.
FR6	Система должна поддерживать режимы игры с конфигурируемым размером команды: 1vs1, 2vs2, 3vs3, 6vs6.
FR7	Система должна уведомлять игровые клиенты/серверы об успешном формировании матча.
FR8	Система должна принимать результаты матча от игрового сервера.
FR9	Система должна передавать результаты матча во внешний сервис для обновления рейтингов игроков.
FR10	Рейтинговая система (Elo, Glicko-2) должна быть легко заменяемой через конфигурацию или плагины.
3.2. Нефункциональные требования (Non-Functional Requirements, NFR)
ID	Requirement
NFR1	Производительность: Система должна обрабатывать не менее 1000 одновременных запросов на поиск матча.
NFR2	Масштабируемость: Архитектура должна позволять горизонтальное масштабирование для обработки пиковых нагрузок.
NFR3	Надежность: Время безотказной работы (uptime) должно составлять не менее 99.9%.
NFR4	Сопровождаемость: Код должен быть хорошо документирован и покрыт модульными и интеграционными тестами.
NFR5	Простота развертывания: Система должна поставляться в виде Docker-контейнера для упрощения развертывания.
NFR6	Открытость: Исходный код проекта должен быть полностью открытым.
4. User Stories
ID	Как...	Я хочу...	Чтобы...
US01	Игрок	нажать кнопку "Найти матч" в игре и выбрать режим 2v2	быстро найти матч с соперниками моего уровня навыков.
US02	Игрок	отменить поиск матча, если он занял слишком много времени	не тратить время впустую и заняться другими делами.
US03	Разработчик игры	интегрировать API матчмейкинга в свою игру	не разрабатывать собственную сложную систему подбора соперников с нуля.
US04	Разработчик игры	легко заменить рейтинговую систему с Elo на Glicko-2	использовать более подходящий алгоритм для моей игры, не переписывая всю логику матчмейкинга.
US05	Администратор	развернуть сервис на собственном сервере	иметь полный контроль над данными и логикой.
US06	Администратор	сконфигурировать максимальное время ожидания в очереди	обеспечить хороший пользовательский опыт для игроков.
5. Конфигурация
Система будет настраиваться через YAML-файл или переменные окружения.

Пример конфигурации:

yaml
server:
  port: 8080

matchmaking:
  modes:
    - name: "1v1"
      team_size: 1
      max_team_diff: 100 # Макс. разница в рейтинге между игроками
      max_wait_time: "90s" # Макс. время в очереди
    - name: "2v2"
      team_size: 2
      max_team_diff: 150
      max_wait_time: "120s"

rating_system:
  type: "glicko2" # "elo" | "glicko" | "glicko2"
  # Параметры, специфичные для системы (например, k-фактор для Elo)

external_service:
  user_service_url: "https://api.my-game.com/users"
  api_key: "${EXTERNAL_SERVICE_API_KEY}"
6. Метрики успеха
Среднее время подбора матча: < 60 секунд для 95% матчей.

Справедливость матчей: Средняя разница в рейтинге между командами в матче не должна превышать установленный порог.

Количество активных развертываний: 100+ независимых развертываний проекта за первый год.

Сообщество: Наличие вкладов (contributions) от сторонних разработчиков.

7. Ограничения
Сервис не является хранилищем данных пользователей и рейтингов.

Сервис не управляет игровыми сессиями (не запускает и не останавливает игровые серверы). Он только подбирает игроков и уведомляет о результате.

Первоначально ориентирован на игры с небольшими командами (до 6 человек в команде).
